name: ðŸ“„ Generate PDFs from Markdown

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**/*.md'
      - '.github/workflows/pdf-generation.yml'
  workflow_dispatch:

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ”§ Install Pandoc and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-latex-base texlive-latex-extra
      
      - name: ðŸ“‚ Create Output Directories
        run: |
          mkdir -p docs/pdf/en
          mkdir -p docs/pdf/es
      
      - name: ðŸ“„ Generate English PDFs
        run: |
          for file in docs/en/sec-rules/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              output="docs/pdf/en/${filename}.pdf"
              echo "Converting $filename to PDF..."
              pandoc \
                --from markdown \
                --to pdf \
                --pdf-engine=xelatex \
                --variable mainfont="DejaVu Sans" \
                --variable monofont="DejaVu Sans Mono" \
                --variable fontsize=11pt \
                --variable geometry:margin=1in \
                --variable colorlinks=true \
                --variable linkcolor=blue \
                --variable urlcolor=blue \
                --toc \
                --toc-depth=2 \
                --number-sections \
                --output "$output" \
                "$file" || echo "Error converting $file"
            fi
          done
          echo "âœ… English PDFs generated"
      
      - name: ðŸ“„ Generate Spanish PDFs
        run: |
          for file in docs/es/sec-rules/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              output="docs/pdf/es/${filename}.pdf"
              echo "Converting $filename to PDF..."
              pandoc \
                --from markdown \
                --to pdf \
                --pdf-engine=xelatex \
                --variable mainfont="DejaVu Sans" \
                --variable monofont="DejaVu Sans Mono" \
                --variable fontsize=11pt \
                --variable geometry:margin=1in \
                --variable colorlinks=true \
                --variable linkcolor=blue \
                --variable urlcolor=blue \
                --toc \
                --toc-depth=2 \
                --number-sections \
                --output "$output" \
                "$file" || echo "Error converting $file"
            fi
          done
          echo "âœ… Spanish PDFs generated"
      
      - name: ðŸ“Š Verify PDF Generation
        run: |
          echo "ðŸ“‹ Files generated:"
          find docs/pdf -name "*.pdf" -type f | wc -l
          echo ""
          echo "ðŸ“ English PDFs:"
          ls -lh docs/pdf/en/ 2>/dev/null | tail -n +2 || echo "No files yet"
          echo ""
          echo "ðŸ“ Spanish PDFs:"
          ls -lh docs/pdf/es/ 2>/dev/null | tail -n +2 || echo "No files yet"
      
      - name: ðŸ“¤ Commit and Push PDFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/pdf/
          if git diff --staged --quiet; then
            echo "âœ“ No PDF changes to commit"
          else
            git commit -m "docs(pdf): auto-generate PDFs from markdown [skip ci]"
            git push
            echo "âœ… PDFs committed and pushed successfully"
          fi
      
      - name: ðŸ“¤ Upload Artifacts (Backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-pdfs
          path: docs/pdf/
          retention-days: 30
