name: ðŸ“„ Generate PDFs and Deploy Docs

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**/*.md'
      - '.github/workflows/pdf-generation.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-latex-base texlive-latex-extra

      - name: ðŸ“‚ Create Output Directories
        run: |
          mkdir -p docs/pdf/en
          mkdir -p docs/pdf/es

      - name: ðŸ“„ Generate English PDFs
        run: |
          for i in {001..012}; do
            input="docs/en/sec-rules/SEC-$i"*.md
            if ls $input 1> /dev/null 2>&1; then
              output="docs/pdf/en/SEC-$i.pdf"
              echo "Converting SEC-$i to PDF..."
              pandoc \
                --from markdown \
                --to pdf \
                --pdf-engine=xelatex \
                --variable mainfont="DejaVu Sans" \
                --variable monofont="DejaVu Sans Mono" \
                --variable fontsize=11pt \
                --variable geometry:margin=1in \
                --variable colorlinks=true \
                --variable linkcolor=blue \
                --variable urlcolor=blue \
                --toc \
                --toc-depth=2 \
                --number-sections \
                --output "$output" \
                $input
            fi
          done

      - name: ðŸ“„ Generate Spanish PDFs
        run: |
          for i in {001..012}; do
            input="docs/es/sec-rules/SEC-$i"*.md
            if ls $input 1> /dev/null 2>&1; then
              output="docs/pdf/es/SEC-$i.pdf"
              echo "Converting SEC-$i (Spanish) to PDF..."
              pandoc \
                --from markdown \
                --to pdf \
                --pdf-engine=xelatex \
                --variable mainfont="DejaVu Sans" \
                --variable monofont="DejaVu Sans Mono" \
                --variable fontsize=11pt \
                --variable geometry:margin=1in \
                --variable colorlinks=true \
                --variable linkcolor=blue \
                --variable urlcolor=blue \
                --toc \
                --toc-depth=2 \
                --number-sections \
                --output "$output" \
                $input
            fi
          done

      - name: ðŸ“Š Verify PDF Generation
        run: |
          echo "âœ… English PDFs:"
          ls -lh docs/pdf/en/ 2>/dev/null || echo "No English PDFs yet"
          echo ""
          echo "âœ… Spanish PDFs:"
          ls -lh docs/pdf/es/ 2>/dev/null || echo "No Spanish PDFs yet"

      - name: ðŸ“¤ Commit Generated PDFs
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/pdf/ 2>/dev/null || true
          if git diff --quiet --cached; then
            echo "âœ“ No changes to commit"
          else
            git commit -m "docs(pdf): auto-generate PDFs [${{ github.run_number }}]"
            git push
          fi

      - name: ðŸ“ˆ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-pdfs
          path: docs/pdf/
          retention-days: 30